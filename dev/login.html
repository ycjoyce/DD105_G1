<!DOCTYPE html>
<html lang="zh_Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @@include('./layout/head.html',{
        "title": "浪愛回家 ｜ 登入"
    })
    <link rel="stylesheet" href="css/login.css">
    <script src="js/heightWithoutHeader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
</head>
<body>
    @@include('./layout/header.html')
    <section>
        <div class="signIn">
            <div class="title">
                <h2 class="before">登入</h2>
                <h3 class="enSpecialFont">Sign in</h3>
            </div>
            <form method="POST">
                <h2>登入</h2>
                <h3 class="enSpecialFont">Sign in</h3>
                <label for="signInAccount">
                    <span class="titleFont">帳號</span>
                    <input type="email" id="signInAccount" placeholder="請輸入E-mail" name="signInAccount" required>
                </label>
                <label for="signInPsw">
                    <span class="titleFont">密碼</span>
                    <input type="password" minlength="4" maxlength="16" id="signInPsw" placeholder="請輸入4-16碼英文、數字" name="signInPsw" required>
                </label>
                <div class="bottom">
                    <div class="more">
                        <span id="forgetPsw">忘記密碼</span>
                        <span id="signUpBtn">註冊新帳號</span>
                    </div>
                    <input type="button" onclick="getMember()" value="登入" class="btn gray titleFont" id="signInSubmit">
                </div>
            </form>
        </div>
        <div class="signUp">
            <div class="title">
                <h2 class="before">註冊</h2>
                <h3 class="enSpecialFont">Sign up</h3>
            </div>
            <form method="POST">
                <h2 class="before">註冊</h2>
                <h3 class="enSpecialFont">Sign up</h3>
                <label for="signUpAccount">
                    <span class="titleFont">帳號</span>
                    <input type="email" id="signUpAccount" placeholder="請輸入E-mail" name="signUpAccount" required>
                </label>

                <label for="signUpName">
                    <span class="titleFont">暱稱</span>
                    <input type="text" minlength="1" maxlength="8" id="signUpName" placeholder="最長8字" name="signUpName" required>
                </label>

                <label for="signUpPsw">
                    <span class="titleFont">密碼</span>
                    <input type="password" minlength="4" maxlength="16" id="signUpPsw" placeholder="請輸入4-16碼英文、數字" name="signUpPsw" required>
                </label>

                <label for="checkPsw">
                    <span class="titleFont">確認密碼</span>
                    <input type="password" id="checkPsw" placeholder="請再次輸入密碼" name="checkPsw" required>
                </label>

                <div class="bottom">
                    <span id="signInBtn">已有帳號?&nbsp;直接登入</span>
                    <input type="button" onclick="addMember()" value="註冊" class="btn gray titleFont" id="signUpSubmit">
                </div>
            </form>
        </div>
    </section>
    <script src="./js/heightWithoutHeader.js"></script>
    <script src="./js/hamburger.js"></script>
    <script>
        sectionHeight();
        window.addEventListener('resize',sectionHeight);

        let signUp= document.querySelector('div.signUp');
        let signIn= document.querySelector('div.signIn');
        let signInCloseTitle= document.querySelector('div.signIn div.title');
        let signUpCloseTitle= document.querySelector('div.signUp div.title');
        let signUpBtn= document.getElementById('signUpBtn');
        let signInBtn= document.getElementById('signInBtn');

        function signUpOpen(e){
            e.stopPropagation();
            if(signUp.classList.contains("open")==false){
                signUp.classList.add("open");
                signIn.classList.add("close");
                signInCloseTitle.classList.add("open");
                signUpCloseTitle.classList.add("close");
            }
            if(document.body.clientWidth<=991){
                signIn.style.display='none';
                signUp.style.display='block';
                signUp.style.width='100%';
            }
        }
        function signInOpen(e){
            e.stopPropagation();
            if(signIn.classList.contains("close")==true){
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");
            }
            if(document.body.clientWidth<=991){
                signUp.style.display='none';
                signIn.style.display='block';
                signIn.style.width='100%';
            }
        }
        signUp.addEventListener('click',signUpOpen);
        signUpBtn.addEventListener('click',signUpOpen);
        signIn.addEventListener('click', signInOpen);
        signInBtn.addEventListener('click', signInOpen);

        function windowSize(){
            //md
            if(document.body.clientWidth>=768 && document.body.clientWidth<=991){
                signUp.style.display= 'none';
                signIn.style.display= 'block';
                signIn.style.width= '100%';
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");

            //lg
            }else if(document.body.clientWidth>=992 && document.body.clientWidth<=1199){
                signUp.style.display= 'block';
                signUp.style.width= 'calc(100% / 12 * 3)';
                signIn.style.display= 'block';
                signIn.style.width= 'calc(100% / 12 * 9)';
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");


            //xl
            }else if(document.body.clientWidth>=1200){
                signUp.style.display= 'block';
                signUp.style.width= 'calc(100% / 12 * 3)';
                signIn.style.display= 'block';
                signIn.style.width= 'calc(100% / 12 * 9)';
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");


            //sm
            }else if(document.body.clientWidth>=576 && document.body.clientWidth<=767){
                signUp.style.display= 'none';
                signIn.style.display= 'block';
                signIn.style.width= '100%';
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");

            //ss
            }else if(document.body.clientWidth<=575){
                signUp.style.display= 'none';
                signIn.style.display= 'block';
                signIn.style.width= '100%';
                signUp.classList.remove("open");
                signIn.classList.remove("close");
                signInCloseTitle.classList.remove("open");
                signUpCloseTitle.classList.remove("close");
            }
        }
        windowSize();
        window.addEventListener('resize',windowSize);

        function getMember(){
            if(document.getElementById("signInAccount").value==""){
                alert("請輸入帳號");
            }else if(document.getElementById("signInAccount").value.indexOf("@")==-1){
                alert("帳號需為E-mail");
            }else if(document.getElementById("signInAccount").value.indexOf("@")==document.getElementById("signUpAccount").value.length-1){
                alert("帳號請輸入完整E-mail");
            }else if(document.getElementById("signInPsw").value==""){
                alert("請輸入密碼");
            }else if(document.getElementById("signInPsw").value.length<4){
                alert("請輸入4-16碼之密碼");
            }else{
                var xhr= new XMLHttpRequest();
                var url= "./php/signIn.php";
                xhr.open("POST",url,true);
                xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                var data_info= "signInAccount="+ document.getElementById("signInAccount").value + "&signInPsw=" + document.getElementById("signInPsw").value;
                xhr.send(data_info);
                
                xhr.onload=function (){
                    if( xhr.status == 200 ){
                        if(xhr.responseText.indexOf("notFound")!=-1){
                            alert("查無此會員，請確認帳號密碼是否正確，若尚無帳號請先註冊!");
                            document.getElementById("signInAccount").value="";
                            document.getElementById("signInPsw").value="";
                        }else{
                            // history.back();
                            location.href="./main.html";
                        }
                    }else{
                        alert( xhr.status );
                    }
                }
            }
        }

        function addMember(){
            var email= document.getElementById("signUpAccount").value;
            var preg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;

            if(document.getElementById("signUpAccount").value==""){
                alert("請輸入帳號");
            }else if(email=='' || !preg.test(email)){
                alert("帳號請填寫正確E-mail");
            }else if(document.getElementById("signUpName").value==""){
                alert("請輸入暱稱");
            }else if(document.getElementById("signUpPsw").value.length<4){
                alert("請輸入4-16碼之密碼");
            }else if(document.getElementById("signUpPsw").value!=document.getElementById("checkPsw").value){
                alert("確認密碼錯誤，請再次確認");
            }else{
                var xhr= new XMLHttpRequest();
                var url= "./php/signUp.php";
                xhr.open("POST",url,true);
                xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                var data_info= "signUpAccount="+document.getElementById("signUpAccount").value+"&signUpName="+document.getElementById("signUpName").value+"&signUpPsw="+document.getElementById("signUpPsw").value+"&checkPsw="+document.getElementById("checkPsw").value;
                xhr.send(data_info);

                xhr.onload=function (){
                    if( xhr.status == 200 ){
                        if(xhr.responseText.indexOf("此帳號已註冊")!=-1){
                            alert(xhr.responseText);
                            document.getElementById("signUpAccount").value="";
                            document.getElementById("signUpPsw").value="";
                            document.getElementById("signUpName").value="";
                            document.getElementById("checkPsw").value="";
                        }else if(xhr.responseText.indexOf("此暱稱已被使用")!=-1){
                            alert(xhr.responseText);
                            document.getElementById("signUpPsw").value="";
                            document.getElementById("signUpName").value="";
                            document.getElementById("checkPsw").value="";
                        }else{
                            alert("註冊成功，請登入");
                            window.location.reload(); 
                        }
                    }else{
                        alert( xhr.status );
                    }
                }
            }
            
        }
    
        let forgetPsw = document.getElementById("forgetPsw");
        forgetPsw.addEventListener("click",findPsw);
        function findPsw(){
            var email= prompt("請輸入註冊帳號(E-mail)");
            var preg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;
            if(email=='' || !preg.test(email)){
                alert("請填寫正確E-mail");
            }else{
                $.ajax({
                    url: './php/forgotPassword.php',
                    data: {"email":email},
                    type: 'POST',
                    dataType: 'json',
                    success(data){
                        if(data == "沒查詢到該郵件"){
                            alert("此E-mail尚未註冊");
                        }else{
                            console.log(data); 
                            alert("已發送，請至信箱收取您的新密碼!");
                        }
                    },
                    error(data){
                        alert("error");
                    },
                });
            }
        }


        //判斷所在頁面
        function checkPage(){
            if(location.pathname.split("/").pop()=="map.html"){
                document.getElementById("navMap").classList.add("active");
            }else if(location.pathname.split("/").pop()=="donation.html"){
                document.getElementById("navDonate").classList.add("active");
            }else if(location.pathname.split("/").pop()=="customized.html"){
                document.getElementById("navCus").classList.add("active");
            }else if(location.pathname.split("/").pop()=="post_article_region.html"){
                document.getElementById("navPost").classList.add("active");
            }else if(location.pathname.split("/").pop()=="aboutus.html"){
                document.getElementById("navAbout").classList.add("active");
            }else if(location.pathname.split("/").pop()=="login.html"){
                document.getElementById("navLogin").classList.add("active");
            }else if(location.pathname.split("/").pop()=="memberCenter.html"){
                document.getElementById("navMem").classList.add("active");
            }else if(location.pathname.split("/").pop()=="message.html"){
                document.getElementById("navMsg").classList.add("active");
            }
            
        }
        checkPage();
    </script>
</body>
</html>
